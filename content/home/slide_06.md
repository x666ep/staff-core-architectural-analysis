### Обработка найма(и оформления)

{{% note %}}

- Смотрим приказы среди потока проведений/отмен и выбираем актуальное состояние, которое помещаем в таблицу актуальных приказов. (db_staff_api.human_resource.employee_hire_status_actual)

- Берем необработанные приказы (дата оформления is null) на найм из таблицы актуальных статусов приказов, к этим приказам джоиним данные по сотрудникам, ключ джоина employeeGUID 

- По каждому сотруднику смотрим есть ли у него ФЛ(по СИДУ, если не нашли то по guid ФЛ), делаем UPSERT ФЛ и сотрудника (сотрудник будет неактивен - is_active = false) 
   
- Формируем событие оформления (EmployeeHireFormalized) 

- помечаем что приказ на найм - оформлен (дата оформления ставится текущей датой) 


- Обрабатываем найм сотрудников 
  - Берем всех у кого было оформление и дата выхода <= текущей дате 
  - Берем всех сотрудников у кого статус приказа - найм 
  - По каждому сотруднику смотрим есть ли у него ФЛ(по СИДУ, если не нашли то по guid ФЛ) - если его нет, формируем ошибку, если ФЛ найдено то обновляем данные по нему если что-то изменилось с момента оформления 
  - Проверяем есть ли ФЛ руководителя этого сотрудника - если оно не найдено, мы его скипаем до след итерации (рукль может появиться позже чем сотрудник) 
  - Активируем сотрудника is_active = true
  - формируем событие EmployeeHired 
  - Помечаем данные о сотруднике обработанными 

{{% /note %}}

раз в 3 минуты запускается крона

processHireChanges
1. Идем в БД, берем все employee_guid у которых есть необработанные приказы (SELECT DISTINCT)
2. В цикле перебираем этих сотрудников и получаем по нему его приказы(все в тч и не обработанные)
3. Вычисляем, применяем новое сотояние если дата события приказа наступила (возможные состояния это Работает ИЛИ Уволен) кладем это все в employee_hire_status_actual 

processEmployeeUpdates
1. Оформление

- Берем необработанные приказы (дата оформления is null) с типом "найм" из таблицы актуальных статусов приказов, к этим приказам джоиним данные по сотрудникам, ключ джоина employeeGUID 

- По каждому сотруднику смотрим есть ли у него ФЛ(по СИДУ, если не нашли то по guid ФЛ), делаем UPSERT ФЛ и сотрудника (сотрудник будет неактивен - is_active = false) 
   
- Формируем событие оформления (EmployeeHireFormalized) 

- помечаем что приказ на найм - оформлен (дата оформления ставится текущей датой) 


1.Найм и обновление

Берем из таблицы employee_hire_status_actual все приказы с типом "оформление" у которых дата оформления is NOT null и джойним к ним последнии изменения из EmployeeLastChangesRaw и у которых Отсутствует флаг обработки событий из EmployeeLastChangesRaw


  - По каждому сотруднику смотрим есть ли у него ФЛ(по СИДУ, если не нашли то по guid ФЛ) - если его нет, формируем ошибку, если ФЛ найдено то обновляем данные по нему если что-то изменилось 

  - Проверяем есть ли ФЛ руководителя этого сотрудника - если оно не найдено, мы его скипаем до след итерации (рукль может появиться позже чем сотрудник) 
  
  - Обновляем сотрудника, в тч активируем если он был деактивирован

  - формируем событие EmployeeHired 
  
  - Помечаем данные о сотруднике обработанными 




processAccountChanges
работает так-же как эмплои processEmployeeUpdates только с другими табличками в контексте аккаунтов (SID)

processGradeChanges
1. Из таблицы актуальных грейдов, берем самые актуальные на текущий момент
2. Смотрим, отличаются ли актуальные цифры от того что записано в табличку employees
3. Если нашли разницу, обновляем эти данные в таблице, шифруем грейд перед отправкой события в кафку
4. отправляем событие

processCBParams
1. Идем в табличку changes
2. Ищем не примененные ченджи
3. Отправляем ивент в кафку и сохраняем в employees новые значения
