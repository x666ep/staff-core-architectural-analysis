<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.129px" preserveAspectRatio="none" style="width:407px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 407 500" width="407.4446px" zoomAndPan="magnify"><defs/><g><ellipse cx="206.9341" cy="18.3534" fill="#222222" rx="9.1767" ry="9.1767" style="stroke:#222222;stroke-width:0.9176679762553411;"/><rect fill="#F1F1F1" height="57.261" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="297.3244" x="58.2719" y="45.8834"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="278.9711" x="67.4486" y="65.7065">Выбираем из таблицы employee_hire_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="255.1117" x="67.4486" y="78.6757">все employee_guid необработанных приказов</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="105.5318" x="67.4486" y="91.6449">(applied_at IS NULL)</text><rect fill="#F1F1F1" height="57.261" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="179.8629" x="117.0027" y="161.8752"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="153.2506" x="126.1793" y="181.6983">для каждого employee_guid</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="147.7445" x="126.1793" y="194.6675">получаем все его приказы</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="161.5096" x="126.1793" y="207.6367">(все в тч и не обработанные)</text><rect fill="#F1F1F1" height="57.261" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="300.0774" x="56.8954" y="237.4896"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="281.7241" x="66.0721" y="257.3127">вычисляем актуальное состояние на текущую дату</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="204.64" x="66.0721" y="270.2819">(те событие приказа уже наступило)</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="206.4753" x="66.0721" y="283.2511">применяя приказы последовательно</text><rect fill="#F1F1F1" height="44.2918" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="212.899" x="100.4846" y="313.104"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="194.5456" x="109.6613" y="332.9271">сохраняем актуальное состояние в</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="150.4975" x="109.6613" y="345.8963">employee_hire_status_actual</text><rect fill="#F1F1F1" height="31.3226" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="331.2781" x="41.2951" y="375.7492"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="312.9248" x="50.4717" y="395.5723">подготавливаем ивент/ивенты для внутреннего топика</text><rect fill="#F1F1F1" height="44.2918" rx="11.4708" ry="11.4708" style="stroke:#181818;stroke-width:0.45883398812767057;" width="299.1598" x="57.3542" y="425.4251"/><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="280.8064" x="66.5309" y="445.2482">кладем наши события в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="11.012" lengthAdjust="spacing" textLength="190.8749" x="66.5309" y="458.2174">для дальнейшей отправки в kafka</text><polygon fill="#F1F1F1" points="97.7316,121.4978,316.1366,121.4978,327.1486,132.5098,316.1366,143.5218,97.7316,143.5218,86.7196,132.5098,97.7316,121.4978" style="stroke:#181818;stroke-width:0.45883398812767057;"/><text fill="#000000" font-family="sans-serif" font-size="10.0943" lengthAdjust="spacing" textLength="218.405" x="97.7316" y="136.3248">Перебираем в цикле массив employee_guid</text><ellipse cx="22.024" cy="171.9695" fill="none" rx="10.0943" ry="10.0943" style="stroke:#222222;stroke-width:0.9176679762553411;"/><ellipse cx="22.024" cy="171.9695" fill="#222222" rx="5.506" ry="5.506" style="stroke:#111111;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="27.53" y2="45.8834"/><polygon fill="#181818" points="203.2635,36.7067,206.9341,45.8834,210.6048,36.7067,206.9341,40.3774" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="219.1362" y2="237.4896"/><polygon fill="#181818" points="203.2635,228.3129,206.9341,237.4896,210.6048,228.3129,206.9341,231.9836" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="294.7507" y2="313.104"/><polygon fill="#181818" points="203.2635,303.9273,206.9341,313.104,210.6048,303.9273,206.9341,307.598" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="357.3958" y2="375.7492"/><polygon fill="#181818" points="203.2635,366.5725,206.9341,375.7492,210.6048,366.5725,206.9341,370.2432" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="407.0718" y2="425.4251"/><polygon fill="#181818" points="203.2635,416.2485,206.9341,425.4251,210.6048,416.2485,206.9341,419.9191" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="143.5218" y2="161.8752"/><polygon fill="#181818" points="203.2635,152.6985,206.9341,161.8752,210.6048,152.6985,206.9341,156.3692" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="469.717" y2="478.8936"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="383.5852" y1="478.8936" y2="478.8936"/><polygon fill="#181818" points="379.9145,313.9607,383.5852,304.7841,387.2559,313.9607,383.5852,310.2901" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="383.5852" x2="383.5852" y1="132.5098" y2="478.8936"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="383.5852" x2="327.1486" y1="132.5098" y2="132.5098"/><polygon fill="#181818" points="336.3253,128.8392,327.1486,132.5098,336.3253,136.1805,332.6546,132.5098" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="86.7196" x2="22.024" y1="132.5098" y2="132.5098"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="22.024" x2="22.024" y1="132.5098" y2="161.8752"/><polygon fill="#181818" points="18.3534,152.6985,22.024,161.8752,25.6947,152.6985,22.024,156.3692" style="stroke:#181818;stroke-width:0.9176679762553411;"/><line style="stroke:#181818;stroke-width:0.9176679762553411;" x1="206.9341" x2="206.9341" y1="103.1444" y2="121.4978"/><polygon fill="#181818" points="203.2635,112.3211,206.9341,121.4978,210.6048,112.3211,206.9341,115.9918" style="stroke:#181818;stroke-width:0.9176679762553411;"/><!--MD5=[aaf2caabb4464112fd45358dd16d6c3a]
@startuml ProcessHireChangesFlow
skinparam ConditionEndStyle hline 
scale max 500 height
    start
        :Выбираем из таблицы employee_hire_changes_raw 
        все employee_guid необработанных приказов 
        (applied_at IS NULL);
        while (Перебираем в цикле массив employee_guid)
            :для каждого employee_guid
            получаем все его приказы
            (все в тч и не обработанные);
            :вычисляем актуальное состояние на текущую дату 
            (те событие приказа уже наступило)
            применяя приказы последовательно;
            :сохраняем актуальное состояние в
            employee_hire_status_actual;
            :подготавливаем ивент/ивенты для внутреннего топика;
            :кладем наши события в табличку employee_events
            для дальнейшей отправки в kafka;
        endwhile
    stop
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>