<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.07px" preserveAspectRatio="none" style="width:609px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 609 500" width="609.912px" zoomAndPan="magnify"><defs/><g><ellipse cx="375.1248" cy="11.5623" fill="#F1F1F1" rx="5.7812" ry="5.7812" style="stroke:#181818;stroke-width:0.28905780704488077;"/><path d="M375.7108,11.6685 L374.8572,9.5073 L374.0002,11.6685 Z M376.4628,13.5857 L375.9174,12.1969 L373.7935,12.1969 L373.2414,13.5857 L372.5808,13.5857 L374.5692,8.5724 L375.2738,8.5724 L377.2317,13.5857 Z " fill="#000000"/><rect fill="none" height="446.8134" style="stroke:#000000;stroke-width:0.8671734211346422;" width="597.1934" x="6.3593" y="23.1246"/><path d="M61.8584,23.1246 L61.8584,28.6099 L56.0772,34.3911 L6.3593,34.3911 " fill="none" style="stroke:#000000;stroke-width:0.8671734211346422;"/><text fill="#000000" font-family="sans-serif" font-size="8.0936" lengthAdjust="spacing" textLength="49.7179" x="8.0936" y="31.5276">Обновление</text><rect fill="#F1F1F1" height="36.0735" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="187.3095" x="281.47" y="44.2191"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="175.7471" x="287.2512" y="56.7073">Выбираем из таблицы employee_hire_status_actual</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="100.014" x="287.2512" y="64.8777">все приказы с типом "Найм"</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="126.6073" x="287.2512" y="73.0481">и датой оформления (formalized_at)</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" font-weight="bold" lengthAdjust="spacing" textLength="45.093" x="416.171" y="73.0481">IS NOT NULL</text><rect fill="#F1F1F1" height="36.0735" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="190.2" x="280.0248" y="91.8549"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="154.3569" x="285.8059" y="104.3431">К приказам делаем JOIN данных состояний</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="176.3253" x="285.8059" y="112.5135">по сотруднику и ФЛ из employee_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="101.1702" x="285.8059" y="120.6839">которые еще не обработаны</text><rect fill="#F1F1F1" height="27.9031" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="153.2006" x="298.5245" y="164.9278"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="80.3581" x="304.3056" y="177.416">Проверяем, есть ли ФЛ</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="141.6383" x="304.3056" y="185.5864">(по СИДУ, если не нашли то по guid ФЛ)</text><polygon fill="#F1F1F1" points="357.7813,204.3932,392.4682,204.3932,399.4056,211.3306,392.4682,218.268,357.7813,218.268,350.8439,211.3306,357.7813,204.3932" style="stroke:#181818;stroke-width:0.28905780704488077;"/><text fill="#000000" font-family="sans-serif" font-size="6.3593" lengthAdjust="spacing" textLength="34.6869" x="357.7813" y="213.734">ФЛ Найден</text><text fill="#000000" font-family="sans-serif" font-size="6.3593" lengthAdjust="spacing" textLength="10.4061" x="340.4378" y="209.9892">yes</text><rect fill="#F1F1F1" height="36.0735" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="80.3581" x="192.657" y="224.0492"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="68.7958" x="198.4382" y="236.5374">Проверяем, есть ли</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="59.5459" x="198.4382" y="244.7078">ФЛ руководителя</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="57.8116" x="198.4382" y="252.8782">этого сотрудник</text><polygon fill="#F1F1F1" points="215.4926,271.685,250.1795,271.685,257.1169,278.6224,250.1795,285.5598,215.4926,285.5598,208.5552,278.6224,215.4926,271.685" style="stroke:#181818;stroke-width:0.28905780704488077;"/><text fill="#000000" font-family="sans-serif" font-size="6.3593" lengthAdjust="spacing" textLength="34.6869" x="215.4926" y="281.0257">ФЛ Найден</text><text fill="#000000" font-family="sans-serif" font-size="6.3593" lengthAdjust="spacing" textLength="10.4061" x="198.1491" y="277.281">yes</text><rect fill="#F1F1F1" height="27.9031" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="175.7471" x="40.179" y="291.3409"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="153.7788" x="45.9602" y="303.8291">делаем UPSERT ФЛ и Сотрудника, при этом</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="164.1848" x="45.9602" y="311.9995">устанавливаем маркер что сотрудник активен</text><rect fill="#F1F1F1" height="19.7327" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="208.6997" x="23.7027" y="330.8063"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="197.1374" x="29.4839" y="343.2945">подготавливаем ивент/ивенты для внутреннего топика</text><rect fill="#F1F1F1" height="27.9031" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="188.4657" x="33.8198" y="362.1014"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="176.9034" x="39.6009" y="374.5896">кладем наши события в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="120.248" x="39.6009" y="382.76">для дальнейшей отправки в kafka</text><rect fill="#F1F1F1" height="27.9031" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="147.9976" x="54.0538" y="401.5668"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="122.5605" x="59.835" y="414.055">помечаем что состояние в таблице</text><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="136.4353" x="59.835" y="422.2254">employee_last_changes_raw применено</text><rect fill="#F1F1F1" height="19.7327" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="187.3095" x="243.9648" y="291.3409"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="175.7471" x="249.7459" y="303.8291">пропускаем сотрудника до следующей итерации</text><rect fill="#F1F1F1" height="19.7327" rx="7.2264" ry="7.2264" style="stroke:#181818;stroke-width:0.28905780704488077;" width="137.5915" x="448.6177" y="224.0492"/><text fill="#000000" font-family="sans-serif" font-size="6.9374" lengthAdjust="spacing" textLength="126.0292" x="454.3989" y="236.5374">кидаем ошибку в лог и пропускаем</text><polygon fill="#F1F1F1" points="296.501,139.4907,453.7485,139.4907,460.6859,146.4281,453.7485,153.3655,296.501,153.3655,289.5637,146.4281,296.501,139.4907" style="stroke:#181818;stroke-width:0.28905780704488077;"/><text fill="#000000" font-family="sans-serif" font-size="6.3593" lengthAdjust="spacing" textLength="157.2474" x="296.501" y="148.8315">Перебираем в цикле массив приказов/состояний</text><ellipse cx="375.1248" cy="487.8596" fill="none" rx="6.3593" ry="6.3593" style="stroke:#222222;stroke-width:0.5781156140897615;"/><ellipse cx="375.1248" cy="487.8596" fill="#222222" rx="3.4687" ry="3.4687" style="stroke:#111111;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="80.2926" y2="91.8549"/><polygon fill="#181818" points="372.8123,86.0737,375.1248,91.8549,377.4372,86.0737,375.1248,88.3862" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="128.0526" y1="319.244" y2="330.8063"/><polygon fill="#181818" points="125.7401,325.0252,128.0526,330.8063,130.3651,325.0252,128.0526,327.3376" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="128.0526" y1="350.539" y2="362.1014"/><polygon fill="#181818" points="125.7401,356.3202,128.0526,362.1014,130.3651,356.3202,128.0526,358.6327" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="128.0526" y1="390.0045" y2="401.5668"/><polygon fill="#181818" points="125.7401,395.7856,128.0526,401.5668,130.3651,395.7856,128.0526,398.0981" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="208.5552" x2="128.0526" y1="278.6224" y2="278.6224"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="128.0526" y1="278.6224" y2="291.3409"/><polygon fill="#181818" points="125.7401,285.5598,128.0526,291.3409,130.3651,285.5598,128.0526,287.8722" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="257.1169" x2="337.6195" y1="278.6224" y2="278.6224"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="337.6195" x2="337.6195" y1="278.6224" y2="291.3409"/><polygon fill="#181818" points="335.3071,285.5598,337.6195,291.3409,339.932,285.5598,337.6195,287.8722" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="128.0526" y1="429.4699" y2="439.876"/><polygon fill="#181818" points="125.7401,434.0948,128.0526,439.876,130.3651,434.0948,128.0526,436.4073" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="337.6195" x2="337.6195" y1="311.0736" y2="439.876"/><polygon fill="#181818" points="335.3071,434.0948,337.6195,439.876,339.932,434.0948,337.6195,436.4073" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="128.0526" x2="337.6195" y1="439.876" y2="439.876"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="232.8361" x2="232.8361" y1="260.1227" y2="271.685"/><polygon fill="#181818" points="230.5236,265.9038,232.8361,271.685,235.1485,265.9038,232.8361,268.2163" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="350.8439" x2="232.8361" y1="211.3306" y2="211.3306"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="232.8361" x2="232.8361" y1="211.3306" y2="224.0492"/><polygon fill="#181818" points="230.5236,218.268,232.8361,224.0492,235.1485,218.268,232.8361,220.5805" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="399.4056" x2="517.4135" y1="211.3306" y2="211.3306"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="517.4135" x2="517.4135" y1="211.3306" y2="224.0492"/><polygon fill="#181818" points="515.101,218.268,517.4135,224.0492,519.7259,218.268,517.4135,220.5805" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="232.8361" x2="232.8361" y1="439.876" y2="450.2821"/><polygon fill="#181818" points="230.5236,444.5009,232.8361,450.2821,235.1485,444.5009,232.8361,446.8134" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="517.4135" x2="517.4135" y1="243.7819" y2="450.2821"/><polygon fill="#181818" points="515.101,444.5009,517.4135,450.2821,519.7259,444.5009,517.4135,446.8134" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="232.8361" x2="517.4135" y1="450.2821" y2="450.2821"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="192.8309" y2="204.3932"/><polygon fill="#181818" points="372.8123,198.6121,375.1248,204.3932,377.4372,198.6121,375.1248,200.9245" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="153.3655" y2="164.9278"/><polygon fill="#181818" points="372.8123,159.1466,375.1248,164.9278,377.4372,159.1466,375.1248,161.4591" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="450.2821" y2="456.0632"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="594.3029" y1="456.0632" y2="456.0632"/><polygon fill="#181818" points="591.9904,310.7846,594.3029,305.0034,596.6153,310.7846,594.3029,308.4721" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="594.3029" x2="594.3029" y1="146.4281" y2="456.0632"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="594.3029" x2="460.6859" y1="146.4281" y2="146.4281"/><polygon fill="#181818" points="466.467,144.1156,460.6859,146.4281,466.467,148.7406,464.1546,146.4281" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="289.5637" x2="15.6091" y1="146.4281" y2="146.4281"/><polygon fill="#181818" points="13.2967,302.6909,15.6091,308.4721,17.9216,302.6909,15.6091,305.0034" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="15.6091" x2="15.6091" y1="146.4281" y2="463.0006"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="15.6091" x2="375.1248" y1="463.0006" y2="463.0006"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="463.0006" y2="481.5003"/><polygon fill="#181818" points="372.8123,475.7191,375.1248,481.5003,377.4372,475.7191,375.1248,478.0316" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="127.9284" y2="139.4907"/><polygon fill="#181818" points="372.8123,133.7096,375.1248,139.4907,377.4372,133.7096,375.1248,136.022" style="stroke:#181818;stroke-width:0.5781156140897615;"/><line style="stroke:#181818;stroke-width:0.5781156140897615;" x1="375.1248" x2="375.1248" y1="17.3435" y2="44.2191"/><polygon fill="#181818" points="372.8123,38.4379,375.1248,44.2191,377.4372,38.4379,375.1248,40.7504" style="stroke:#181818;stroke-width:0.5781156140897615;"/><!--MD5=[de0fff3bfd1cfca80049f78c377843bd]
@startuml ProcessEmployeeUpdatesPg2
skinparam ConditionEndStyle hline 
scale max 500 height
        (A)
        group Обновление
            :Выбираем из таблицы employee_hire_status_actual 
            все приказы с типом "Найм" 
            и датой оформления (formalized_at) **IS NOT NULL**;
            :К приказам делаем JOIN данных состояний 
            по сотруднику и ФЛ из employee_last_changes_raw 
            которые еще не обработаны;
            while (Перебираем в цикле массив приказов/состояний)
                :Проверяем, есть ли ФЛ
                (по СИДУ, если не нашли то по guid ФЛ);
                if (ФЛ Найден) then (yes)
                :Проверяем, есть ли 
                ФЛ руководителя 
                этого сотрудник;
                    if (ФЛ Найден) then (yes)
                        :делаем UPSERT ФЛ и Сотрудника, при этом
                        устанавливаем маркер что сотрудник активен;
                        :подготавливаем ивент/ивенты для внутреннего топика;
                        :кладем наши события в табличку employee_events
                        для дальнейшей отправки в kafka;
                        :помечаем что состояние в таблице 
                        employee_last_changes_raw применено;
                        else
                        :пропускаем сотрудника до следующей итерации;
                    endif
                    else
                    :кидаем ошибку в лог и пропускаем;
                endif
            endwhile
        end group
    stop
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>