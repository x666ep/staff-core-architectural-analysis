<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.7078px" preserveAspectRatio="none" style="width:628px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 628 500" width="628.7426px" zoomAndPan="magnify"><defs/><g><ellipse cx="331.3283" cy="15.2422" fill="#222222" rx="7.6211" ry="7.6211" style="stroke:#222222;stroke-width:0.7621123014154151;"/><rect fill="#F1F1F1" height="26.013" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="146.3256" x="258.1655" y="38.1056"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="131.0833" x="265.7867" y="54.5684">Получаем событие из кафки</text><rect fill="#F1F1F1" height="36.7838" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="219.4883" x="221.5842" y="79.3609"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="204.2461" x="229.2053" y="95.8237">Запрашиваем из БД предыдущее состояние</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="170.7132" x="229.2053" y="106.5945">из таблицы account_last_changes_raw</text><polygon fill="#F1F1F1" points="271.5025,131.387,391.1541,131.387,400.2995,140.5323,391.1541,149.6777,271.5025,149.6777,262.3572,140.5323,271.5025,131.387" style="stroke:#181818;stroke-width:0.38105615070770754;"/><text fill="#000000" font-family="sans-serif" font-size="8.3832" lengthAdjust="spacing" textLength="119.6516" x="271.5025" y="143.7006">Предыдущее состояние есть</text><text fill="#000000" font-family="sans-serif" font-size="8.3832" lengthAdjust="spacing" textLength="13.718" x="248.6391" y="138.764">yes</text><rect fill="#F1F1F1" height="47.5546" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="332.281" x="8.3832" y="157.2988"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="195.8629" x="16.0044" y="173.7616">создаем обьект с полями prev_data и data</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="317.0387" x="16.0044" y="184.5324">наполняем prev_data данными из поля data предыдущего сотояния</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="189.766" x="16.0044" y="195.3032">а data наполняется данными из события</text><rect fill="#F1F1F1" height="26.013" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="200.4355" x="74.3059" y="220.0957"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="185.1933" x="81.9271" y="236.5585">построчно сравниваем prev_data и data</text><rect fill="#F1F1F1" height="26.013" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="86.8808" x="131.0833" y="309.0671"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="71.6386" x="138.7044" y="325.5299">формируем diff</text><rect fill="#F1F1F1" height="26.013" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="213.3914" x="67.828" y="350.3223"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="198.1492" x="75.4491" y="366.7852">кладем его в таблицу account_changes_raw</text><rect fill="#F1F1F1" height="36.7838" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="264.453" x="42.2972" y="391.5776"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="249.2107" x="49.9184" y="408.0404">объект сохраняем в таблицу account_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="156.233" x="49.9184" y="418.8112">с пометкой events_created = false</text><polygon fill="#F1F1F1" points="157.3762,272.1217,191.6712,272.1217,200.8166,281.2671,191.6712,290.4124,157.3762,290.4124,148.2308,281.2671,157.3762,272.1217" style="stroke:#181818;stroke-width:0.38105615070770754;"/><text fill="#000000" font-family="sans-serif" font-size="8.3832" lengthAdjust="spacing" textLength="13.718" x="177.5722" y="298.5173">yes</text><text fill="#000000" font-family="sans-serif" font-size="8.3832" lengthAdjust="spacing" textLength="34.2951" x="157.3762" y="284.4353">Есть Diff</text><rect fill="#F1F1F1" height="47.5546" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="211.1051" x="382.5804" y="157.2988"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="195.8629" x="390.2015" y="173.7616">создаем обьект с полями prev_data и data</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="109.7442" x="390.2015" y="184.5324">prev_data будет пустым</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="189.766" x="390.2015" y="195.3032">а data наполняется данными из события</text><rect fill="#F1F1F1" height="36.7838" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="244.638" x="365.8139" y="220.0957"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="201.1976" x="373.435" y="236.5585">записываем в таблицу account_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="229.3958" x="373.435" y="247.3293">новую строчку с полной информацией из ивента</text><rect fill="#F1F1F1" height="36.7838" rx="9.5264" ry="9.5264" style="stroke:#181818;stroke-width:0.38105615070770754;" width="264.453" x="355.9064" y="282.8925"/><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="249.2107" x="363.5276" y="299.3553">объект сохраняем в таблицу account_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="9.1453" lengthAdjust="spacing" textLength="156.233" x="363.5276" y="310.1261">с пометкой events_created = false</text><ellipse cx="331.3283" cy="483.9956" fill="none" rx="8.3832" ry="8.3832" style="stroke:#222222;stroke-width:0.7621123014154151;"/><ellipse cx="331.3283" cy="483.9956" fill="#222222" rx="4.5727" ry="4.5727" style="stroke:#111111;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="331.3283" x2="331.3283" y1="22.8634" y2="38.1056"/><polygon fill="#181818" points="328.2799,30.4845,331.3283,38.1056,334.3768,30.4845,331.3283,33.5329" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="331.3283" x2="331.3283" y1="64.1187" y2="79.3609"/><polygon fill="#181818" points="328.2799,71.7398,331.3283,79.3609,334.3768,71.7398,331.3283,74.7882" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="204.8534" y2="220.0957"/><polygon fill="#181818" points="171.4753,212.4745,174.5237,220.0957,177.5722,212.4745,174.5237,215.523" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="335.0801" y2="350.3223"/><polygon fill="#181818" points="171.4753,342.7012,174.5237,350.3223,177.5722,342.7012,174.5237,345.7497" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="376.3354" y2="391.5776"/><polygon fill="#181818" points="171.4753,383.9565,174.5237,391.5776,177.5722,383.9565,174.5237,387.0049" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="290.4124" y2="309.0671"/><polygon fill="#181818" points="171.4753,301.4459,174.5237,309.0671,177.5722,301.4459,174.5237,304.4944" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="200.8166" x2="314.3713" y1="281.2671" y2="281.2671"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="314.3713" x2="314.3713" y1="281.2671" y2="445.1279"/><polygon fill="#181818" points="311.3229,437.5068,314.3713,445.1279,317.4198,437.5068,314.3713,440.5552" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="314.3713" x2="174.5237" y1="445.1279" y2="445.1279"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="445.1279" y2="448.9385"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="428.3614" y2="445.1279"/><polygon fill="#181818" points="171.4753,437.5068,174.5237,445.1279,177.5722,437.5068,174.5237,440.5552" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="246.1087" y2="272.1217"/><polygon fill="#181818" points="171.4753,264.5006,174.5237,272.1217,177.5722,264.5006,174.5237,267.549" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="488.1329" x2="488.1329" y1="204.8534" y2="220.0957"/><polygon fill="#181818" points="485.0845,212.4745,488.1329,220.0957,491.1814,212.4745,488.1329,215.523" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="488.1329" x2="488.1329" y1="256.8795" y2="282.8925"/><polygon fill="#181818" points="485.0845,275.2714,488.1329,282.8925,491.1814,275.2714,488.1329,278.3198" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="262.3572" x2="174.5237" y1="140.5323" y2="140.5323"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="140.5323" y2="157.2988"/><polygon fill="#181818" points="171.4753,149.6777,174.5237,157.2988,177.5722,149.6777,174.5237,152.7261" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="400.2995" x2="488.1329" y1="140.5323" y2="140.5323"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="488.1329" x2="488.1329" y1="140.5323" y2="157.2988"/><polygon fill="#181818" points="485.0845,149.6777,488.1329,157.2988,491.1814,149.6777,488.1329,152.7261" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="174.5237" y1="448.9385" y2="460.3702"/><polygon fill="#181818" points="171.4753,452.749,174.5237,460.3702,177.5722,452.749,174.5237,455.7975" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="488.1329" x2="488.1329" y1="319.6763" y2="460.3702"/><polygon fill="#181818" points="485.0845,452.749,488.1329,460.3702,491.1814,452.749,488.1329,455.7975" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="174.5237" x2="488.1329" y1="460.3702" y2="460.3702"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="331.3283" x2="331.3283" y1="116.1447" y2="131.387"/><polygon fill="#181818" points="328.2799,123.7658,331.3283,131.387,334.3768,123.7658,331.3283,126.8143" style="stroke:#181818;stroke-width:0.7621123014154151;"/><line style="stroke:#181818;stroke-width:0.7621123014154151;" x1="331.3283" x2="331.3283" y1="460.3702" y2="475.6124"/><polygon fill="#181818" points="328.2799,467.9913,331.3283,475.6124,334.3768,467.9913,331.3283,471.0397" style="stroke:#181818;stroke-width:0.7621123014154151;"/><!--MD5=[6852b144a2fdb570696b598f41bbcce1]
@startuml FillChangesFlowAccountsTopic
skinparam ConditionEndStyle hline 
scale max 500 height
    start
        :Получаем событие из кафки;
        :Запрашиваем из БД предыдущее состояние
        из таблицы account_last_changes_raw;
        if (Предыдущее состояние есть) then (yes)
                :создаем обьект с полями prev_data и data
                наполняем prev_data данными из поля data предыдущего сотояния
                а data наполняется данными из события;
                :построчно сравниваем prev_data и data;
                if (Есть Diff) then (yes)
                    :формируем diff;
                    :кладем его в таблицу account_changes_raw;
                    :объект сохраняем в таблицу account_last_changes_raw
                    с пометкой events_created = false;
                endif
               else
                :создаем обьект с полями prev_data и data
                prev_data будет пустым
                а data наполняется данными из события;
                :записываем в таблицу account_changes_raw 
                новую строчку с полной информацией из ивента;
                :объект сохраняем в таблицу account_last_changes_raw
                с пометкой events_created = false;
            endif
    stop
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>