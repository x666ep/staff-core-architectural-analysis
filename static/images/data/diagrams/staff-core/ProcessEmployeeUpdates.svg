<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.2207px" preserveAspectRatio="none" style="width:365px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 365 500" width="365.7797px" zoomAndPan="magnify"><defs/><g><ellipse cx="222.4891" cy="7.1511" fill="#222222" rx="3.5756" ry="3.5756" style="stroke:#222222;stroke-width:0.3575558820736006;"/><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="35.398" x="204.7901" y="17.8778"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="28.2469" x="208.3657" y="25.6016">Оформление</text><rect fill="#F1F1F1" height="22.3109" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="115.8481" x="164.5651" y="37.2333"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="108.697" x="168.1407" y="44.9571">Выбираем из таблицы employee_hire_status_actual</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="61.8572" x="168.1407" y="50.0103">все приказы с типом "Найм"</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="78.3047" x="168.1407" y="55.0636">и датой оформления (formalized_at)</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" font-weight="bold" lengthAdjust="spacing" textLength="16.8051" x="247.8756" y="55.0636">IS NULL</text><rect fill="#F1F1F1" height="22.3109" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="117.6359" x="163.6712" y="66.6953"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="95.4674" x="167.2468" y="74.4191">К приказам делаем JOIN данных состояний</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="109.0545" x="167.2468" y="79.4724">по сотруднику и ФЛ из employee_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="62.5723" x="167.2468" y="84.5257">которые еще не обработаны</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="114.0603" x="165.459" y="111.8899"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="95.1099" x="169.0345" y="119.6136">делаем UPSERT ФЛ и Сотрудника, при этом</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="106.9092" x="169.0345" y="124.6669">устанавливаем маркер что сотрудник неактивен</text><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="111.1999" x="166.8892" y="136.2986"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="104.0488" x="170.4648" y="144.0224">подготавливаем ивент для внутреннего топика</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="116.5632" x="164.2075" y="161.0175"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="109.4121" x="167.7831" y="168.7412">кладем наше событие в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="74.3716" x="167.7831" y="173.7945">для дальнейшей отправки в kafka</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="102.261" x="171.3587" y="185.4262"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="94.0372" x="174.9342" y="193.15">помечаем что приказ на найм - оформлен</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="95.1099" x="174.9342" y="198.2033">(дата оформления ставится текущей датой)</text><polygon fill="#F1F1F1" points="173.8615,96.1574,271.1167,96.1574,275.4074,100.4481,271.1167,104.7387,173.8615,104.7387,169.5709,100.4481,173.8615,96.1574" style="stroke:#181818;stroke-width:0.1787779410368003;"/><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="97.2552" x="173.8615" y="101.9345">Перебираем в цикле массив приказов/состояний</text><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="33.6103" x="205.684" y="217.7013"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="26.4591" x="209.2596" y="225.425">Обновление</text><rect fill="#F1F1F1" height="22.3109" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="115.8481" x="164.5651" y="237.0568"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="108.697" x="168.1407" y="244.7805">Выбираем из таблицы employee_hire_status_actual</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="61.8572" x="168.1407" y="249.8338">все приказы с типом "Найм"</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="78.3047" x="168.1407" y="254.8871">и датой оформления (formalized_at)</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" font-weight="bold" lengthAdjust="spacing" textLength="27.8894" x="247.8756" y="254.8871">IS NOT NULL</text><rect fill="#F1F1F1" height="22.3109" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="117.6359" x="163.6712" y="266.5188"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="95.4674" x="167.2468" y="274.2426">К приказам делаем JOIN данных состояний</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="109.0545" x="167.2468" y="279.2958">по сотруднику и ФЛ из employee_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="62.5723" x="167.2468" y="284.3491">которые еще не обработаны</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="94.7523" x="175.113" y="311.7133"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="49.7003" x="178.6886" y="319.4371">Проверяем, есть ли ФЛ</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="87.6012" x="178.6886" y="324.4903">(по СИДУ, если не нашли то по guid ФЛ)</text><polygon fill="#F1F1F1" points="211.7625,336.1221,233.2158,336.1221,237.5065,340.4128,233.2158,344.7034,211.7625,344.7034,207.4718,340.4128,211.7625,336.1221" style="stroke:#181818;stroke-width:0.1787779410368003;"/><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="21.4534" x="211.7625" y="341.8992">ФЛ Найден</text><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="6.436" x="201.0358" y="339.5831">yes</text><rect fill="#F1F1F1" height="22.3109" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="49.7003" x="111.1999" y="348.279"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="42.5491" x="114.7754" y="356.0027">Проверяем, есть ли</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="36.8283" x="114.7754" y="361.056">ФЛ руководителя</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="35.7556" x="114.7754" y="366.1093">этого сотрудник</text><polygon fill="#F1F1F1" points="125.3233,377.741,146.7767,377.741,151.0674,382.0317,146.7767,386.3224,125.3233,386.3224,121.0327,382.0317,125.3233,377.741" style="stroke:#181818;stroke-width:0.1787779410368003;"/><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="21.4534" x="125.3233" y="383.5181">ФЛ Найден</text><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="6.436" x="114.5967" y="381.2021">yes</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="108.697" x="20.0231" y="389.8979"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="95.1099" x="23.5987" y="397.6217">делаем UPSERT ФЛ и Сотрудника, при этом</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="101.5459" x="23.5987" y="402.675">устанавливаем маркер что сотрудник активен</text><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="111.1999" x="18.7717" y="414.3067"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="104.0488" x="22.3472" y="422.0305">подготавливаем ивент для внутреннего топика</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="116.5632" x="16.09" y="433.6622"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="109.4121" x="19.6656" y="441.386">кладем наше событие в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="74.3716" x="19.6656" y="446.4392">для дальнейшей отправки в kafka</text><rect fill="#F1F1F1" height="17.2577" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="91.5343" x="28.6045" y="458.071"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="75.8018" x="32.18" y="465.7948">помечаем что состояние в таблице</text><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="84.3832" x="32.18" y="470.848">employee_last_changes_raw применено</text><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="115.8481" x="139.8043" y="389.8979"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="108.697" x="143.3799" y="397.6217">пропускаем сотрудника до следующей итерации</text><rect fill="#F1F1F1" height="12.2044" rx="4.4694" ry="4.4694" style="stroke:#181818;stroke-width:0.1787779410368003;" width="85.0983" x="266.3791" y="348.279"/><text fill="#000000" font-family="sans-serif" font-size="4.2907" lengthAdjust="spacing" textLength="77.9472" x="269.9547" y="356.0027">кидаем ошибку в лог и пропускаем</text><polygon fill="#F1F1F1" points="173.8615,295.9808,271.1167,295.9808,275.4074,300.2715,271.1167,304.5622,173.8615,304.5622,169.5709,300.2715,173.8615,295.9808" style="stroke:#181818;stroke-width:0.1787779410368003;"/><text fill="#000000" font-family="sans-serif" font-size="3.9331" lengthAdjust="spacing" textLength="97.2552" x="173.8615" y="301.758">Перебираем в цикле массив приказов/состояний</text><ellipse cx="8.5813" cy="315.6464" fill="none" rx="3.9331" ry="3.9331" style="stroke:#222222;stroke-width:0.3575558820736006;"/><ellipse cx="8.5813" cy="315.6464" fill="#222222" rx="2.1453" ry="2.1453" style="stroke:#111111;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="10.7267" y2="17.8778"/><polygon fill="#181818" points="221.0589,14.3022,222.4891,17.8778,223.9194,14.3022,222.4891,15.7325" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="30.0822" y2="37.2333"/><polygon fill="#181818" points="221.0589,33.6577,222.4891,37.2333,223.9194,33.6577,222.4891,35.088" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="59.5442" y2="66.6953"/><polygon fill="#181818" points="221.0589,63.1198,222.4891,66.6953,223.9194,63.1198,222.4891,64.55" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="129.1475" y2="136.2986"/><polygon fill="#181818" points="221.0589,132.7231,222.4891,136.2986,223.9194,132.7231,222.4891,134.1533" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="148.503" y2="161.0175"/><polygon fill="#181818" points="221.0589,157.4419,222.4891,161.0175,223.9194,157.4419,222.4891,158.8721" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="178.2751" y2="185.4262"/><polygon fill="#181818" points="221.0589,181.8507,222.4891,185.4262,223.9194,181.8507,222.4891,183.2809" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="104.7387" y2="111.8899"/><polygon fill="#181818" points="221.0589,108.3143,222.4891,111.8899,223.9194,108.3143,222.4891,109.7445" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="202.6839" y2="206.2595"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="285.0614" y1="206.2595" y2="206.2595"/><polygon fill="#181818" points="283.6312,156.5718,285.0614,152.9962,286.4917,156.5718,285.0614,155.1415" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="285.0614" x2="285.0614" y1="100.4481" y2="206.2595"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="285.0614" x2="275.4074" y1="100.4481" y2="100.4481"/><polygon fill="#181818" points="278.983,99.0178,275.4074,100.4481,278.983,101.8783,277.5528,100.4481" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="169.5709" x2="159.9169" y1="100.4481" y2="100.4481"/><polygon fill="#181818" points="158.4866,151.566,159.9169,155.1415,161.3471,151.566,159.9169,152.9962" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="159.9169" x2="159.9169" y1="100.4481" y2="210.5501"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="159.9169" x2="222.4891" y1="210.5501" y2="210.5501"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="210.5501" y2="217.7013"/><polygon fill="#181818" points="221.0589,214.1257,222.4891,217.7013,223.9194,214.1257,222.4891,215.5559" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="89.0063" y2="96.1574"/><polygon fill="#181818" points="221.0589,92.5818,222.4891,96.1574,223.9194,92.5818,222.4891,94.0121" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="229.9056" y2="237.0568"/><polygon fill="#181818" points="221.0589,233.4812,222.4891,237.0568,223.9194,233.4812,222.4891,234.9114" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="259.3677" y2="266.5188"/><polygon fill="#181818" points="221.0589,262.9432,222.4891,266.5188,223.9194,262.9432,222.4891,264.3735" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="74.3716" y1="407.1556" y2="414.3067"/><polygon fill="#181818" points="72.9414,410.7311,74.3716,414.3067,75.8018,410.7311,74.3716,412.1614" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="74.3716" y1="426.5111" y2="433.6622"/><polygon fill="#181818" points="72.9414,430.0867,74.3716,433.6622,75.8018,430.0867,74.3716,431.5169" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="74.3716" y1="450.9199" y2="458.071"/><polygon fill="#181818" points="72.9414,454.4954,74.3716,458.071,75.8018,454.4954,74.3716,455.9257" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="121.0327" x2="74.3716" y1="382.0317" y2="382.0317"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="74.3716" y1="382.0317" y2="389.8979"/><polygon fill="#181818" points="72.9414,386.3224,74.3716,389.8979,75.8018,386.3224,74.3716,387.7526" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="151.0674" x2="197.7284" y1="382.0317" y2="382.0317"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="197.7284" x2="197.7284" y1="382.0317" y2="389.8979"/><polygon fill="#181818" points="196.2982,386.3224,197.7284,389.8979,199.1586,386.3224,197.7284,387.7526" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="74.3716" y1="475.3286" y2="481.7647"/><polygon fill="#181818" points="72.9414,478.1891,74.3716,481.7647,75.8018,478.1891,74.3716,479.6193" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="197.7284" x2="197.7284" y1="402.1023" y2="481.7647"/><polygon fill="#181818" points="196.2982,478.1891,197.7284,481.7647,199.1586,478.1891,197.7284,479.6193" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="74.3716" x2="197.7284" y1="481.7647" y2="481.7647"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="136.05" x2="136.05" y1="370.5899" y2="377.741"/><polygon fill="#181818" points="134.6198,374.1655,136.05,377.741,137.4802,374.1655,136.05,375.5957" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="207.4718" x2="136.05" y1="340.4128" y2="340.4128"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="136.05" x2="136.05" y1="340.4128" y2="348.279"/><polygon fill="#181818" points="134.6198,344.7034,136.05,348.279,137.4802,344.7034,136.05,346.1336" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="237.5065" x2="308.9283" y1="340.4128" y2="340.4128"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="308.9283" x2="308.9283" y1="340.4128" y2="348.279"/><polygon fill="#181818" points="307.4981,344.7034,308.9283,348.279,310.3585,344.7034,308.9283,346.1336" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="136.05" x2="136.05" y1="481.7647" y2="488.2007"/><polygon fill="#181818" points="134.6198,484.6251,136.05,488.2007,137.4802,484.6251,136.05,486.0553" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="308.9283" x2="308.9283" y1="360.4834" y2="488.2007"/><polygon fill="#181818" points="307.4981,484.6251,308.9283,488.2007,310.3585,484.6251,308.9283,486.0553" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="136.05" x2="308.9283" y1="488.2007" y2="488.2007"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="328.971" y2="336.1221"/><polygon fill="#181818" points="221.0589,332.5465,222.4891,336.1221,223.9194,332.5465,222.4891,333.9767" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="304.5622" y2="311.7133"/><polygon fill="#181818" points="221.0589,308.1377,222.4891,311.7133,223.9194,308.1377,222.4891,309.568" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="488.2007" y2="491.7762"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="356.4832" y1="491.7762" y2="491.7762"/><polygon fill="#181818" points="355.053,401.9235,356.4832,398.348,357.9134,401.9235,356.4832,400.4933" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="356.4832" x2="356.4832" y1="300.2715" y2="491.7762"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="356.4832" x2="275.4074" y1="300.2715" y2="300.2715"/><polygon fill="#181818" points="278.983,298.8413,275.4074,300.2715,278.983,301.7017,277.5528,300.2715" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="169.5709" x2="8.5813" y1="300.2715" y2="300.2715"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="8.5813" x2="8.5813" y1="300.2715" y2="311.7133"/><polygon fill="#181818" points="7.1511,308.1377,8.5813,311.7133,10.0116,308.1377,8.5813,309.568" style="stroke:#181818;stroke-width:0.3575558820736006;"/><line style="stroke:#181818;stroke-width:0.3575558820736006;" x1="222.4891" x2="222.4891" y1="288.8297" y2="295.9808"/><polygon fill="#181818" points="221.0589,292.4053,222.4891,295.9808,223.9194,292.4053,222.4891,293.8355" style="stroke:#181818;stroke-width:0.3575558820736006;"/><!--MD5=[9c654d5783720f3e60ab660b99212174]
@startuml ProcessEmployeeUpdates
skinparam ConditionEndStyle hline 
scale max 500 height
    start
        :Оформление;
        :Выбираем из таблицы employee_hire_status_actual 
        все приказы с типом "Найм" 
        и датой оформления (formalized_at) **IS NULL**;
        :К приказам делаем JOIN данных состояний 
        по сотруднику и ФЛ из employee_last_changes_raw 
        которые еще не обработаны;
        while (Перебираем в цикле массив приказов/состояний)
            :делаем UPSERT ФЛ и Сотрудника, при этом
            устанавливаем маркер что сотрудник неактивен;
            :подготавливаем ивент для внутреннего топика;
            :кладем наше событие в табличку employee_events
            для дальнейшей отправки в kafka;
            :помечаем что приказ на найм - оформлен 
            (дата оформления ставится текущей датой);
        endwhile
        :Обновление;
        :Выбираем из таблицы employee_hire_status_actual 
        все приказы с типом "Найм" 
        и датой оформления (formalized_at) **IS NOT NULL**;
        :К приказам делаем JOIN данных состояний 
        по сотруднику и ФЛ из employee_last_changes_raw 
        которые еще не обработаны;
        while (Перебираем в цикле массив приказов/состояний)
            :Проверяем, есть ли ФЛ
            (по СИДУ, если не нашли то по guid ФЛ);
            if (ФЛ Найден) then (yes)
            :Проверяем, есть ли 
            ФЛ руководителя 
            этого сотрудник;
                if (ФЛ Найден) then (yes)
                    :делаем UPSERT ФЛ и Сотрудника, при этом
                    устанавливаем маркер что сотрудник активен;
                    :подготавливаем ивент для внутреннего топика;
                    :кладем наше событие в табличку employee_events
                    для дальнейшей отправки в kafka;
                    :помечаем что состояние в таблице 
                    employee_last_changes_raw применено;
                    else
                    :пропускаем сотрудника до следующей итерации;
                endif
                else
                :кидаем ошибку в лог и пропускаем;
            endif
        endwhile
    stop
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>