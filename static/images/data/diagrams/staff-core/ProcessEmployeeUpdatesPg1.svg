<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.6299px" preserveAspectRatio="none" style="width:352px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 352 500" width="352.206px" zoomAndPan="magnify"><defs/><g><ellipse cx="176.103" cy="16.0458" fill="#222222" rx="8.0229" ry="8.0229" style="stroke:#222222;stroke-width:0.8022915452260518;"/><rect fill="none" height="427.7938" style="stroke:#000000;stroke-width:1.2034373178390778;" width="334.5556" x="8.8252" y="32.0917"/><path d="M90.6589,32.0917 L90.6589,39.704 L82.636,47.7269 L8.8252,47.7269 " fill="none" style="stroke:#000000;stroke-width:1.2034373178390778;"/><text fill="#000000" font-family="sans-serif" font-size="11.2321" lengthAdjust="spacing" textLength="73.8108" x="11.2321" y="43.7531">Оформление</text><rect fill="#F1F1F1" height="50.0617" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="259.9425" x="46.1318" y="61.3659"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="243.8966" x="54.1547" y="78.6967">Выбираем из таблицы employee_hire_status_actual</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="138.7964" x="54.1547" y="90.0353">все приказы с типом "Найм"</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="175.7018" x="54.1547" y="101.3739">и датой оформления (formalized_at)</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" font-weight="bold" lengthAdjust="spacing" textLength="37.7077" x="233.0657" y="101.3739">IS NULL</text><rect fill="#F1F1F1" height="50.0617" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="263.9539" x="44.126" y="127.4735"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="214.2118" x="52.149" y="144.8042">К приказам делаем JOIN данных состояний</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="244.6989" x="52.149" y="156.1429">по сотруднику и ФЛ из employee_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="140.401" x="52.149" y="167.4815">которые еще не обработаны</text><rect fill="#F1F1F1" height="38.7231" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="255.931" x="48.1375" y="228.8819"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="213.4096" x="56.1604" y="246.2126">делаем UPSERT ФЛ и Сотрудника, при этом</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="239.8852" x="56.1604" y="257.5513">устанавливаем маркер что сотрудник неактивен</text><rect fill="#F1F1F1" height="27.3845" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="289.6272" x="31.2894" y="283.6508"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="273.5814" x="39.3123" y="300.9816">подготавливаем ивент/ивенты для внутреннего топика</text><rect fill="#F1F1F1" height="38.7231" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="261.547" x="45.3295" y="339.1155"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="245.5012" x="53.3524" y="356.4462">кладем наши события в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="166.8766" x="53.3524" y="367.7849">для дальнейшей отправки в kafka</text><rect fill="#F1F1F1" height="38.7231" rx="10.0286" ry="10.0286" style="stroke:#181818;stroke-width:0.4011457726130259;" width="229.4554" x="61.3753" y="393.8844"/><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="211.0027" x="69.3982" y="411.2152">помечаем что приказ на найм - оформлен</text><text fill="#000000" font-family="sans-serif" font-size="9.6275" lengthAdjust="spacing" textLength="213.4096" x="69.3982" y="422.5538">(дата оформления ставится текущей датой)</text><polygon fill="#F1F1F1" points="66.9913,193.581,285.2146,193.581,294.8421,203.2085,285.2146,212.836,66.9913,212.836,57.3638,203.2085,66.9913,193.581" style="stroke:#181818;stroke-width:0.4011457726130259;"/><text fill="#000000" font-family="sans-serif" font-size="8.8252" lengthAdjust="spacing" textLength="218.2233" x="66.9913" y="206.5438">Перебираем в цикле массив приказов/состояний</text><ellipse cx="176.103" cy="483.9542" fill="#F1F1F1" rx="8.0229" ry="8.0229" style="stroke:#181818;stroke-width:0.4011457726130259;"/><path d="M176.9163,484.1015 L175.7316,481.1023 L174.5423,484.1015 Z M177.9599,486.7622 L177.203,484.8348 L174.2555,484.8348 L173.4893,486.7622 L172.5726,486.7622 L175.332,479.8048 L176.3098,479.8048 L179.027,486.7622 Z " fill="#000000"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="111.4276" y2="127.4735"/><polygon fill="#181818" points="172.8938,119.4506,176.103,127.4735,179.3122,119.4506,176.103,122.6597" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="267.605" y2="283.6508"/><polygon fill="#181818" points="172.8938,275.6279,176.103,283.6508,179.3122,275.6279,176.103,278.8371" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="311.0353" y2="339.1155"/><polygon fill="#181818" points="172.8938,331.0926,176.103,339.1155,179.3122,331.0926,176.103,334.3017" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="377.8386" y2="393.8844"/><polygon fill="#181818" points="172.8938,385.8615,176.103,393.8844,179.3122,385.8615,176.103,389.0707" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="212.836" y2="228.8819"/><polygon fill="#181818" points="172.8938,220.859,176.103,228.8819,179.3122,220.859,176.103,224.0681" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="432.6075" y2="440.6304"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="330.5441" y1="440.6304" y2="440.6304"/><polygon fill="#181818" points="327.335,329.1401,330.5441,321.1172,333.7533,329.1401,330.5441,325.9309" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="330.5441" x2="330.5441" y1="203.2085" y2="440.6304"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="330.5441" x2="294.8421" y1="203.2085" y2="203.2085"/><polygon fill="#181818" points="302.8651,199.9994,294.8421,203.2085,302.8651,206.4177,299.6559,203.2085" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="57.3638" x2="21.6619" y1="203.2085" y2="203.2085"/><polygon fill="#181818" points="18.4527,317.908,21.6619,325.9309,24.871,317.908,21.6619,321.1172" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="21.6619" x2="21.6619" y1="203.2085" y2="450.2579"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="21.6619" x2="176.103" y1="450.2579" y2="450.2579"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="450.2579" y2="475.9313"/><polygon fill="#181818" points="172.8938,467.9083,176.103,475.9313,179.3122,467.9083,176.103,471.1175" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="177.5352" y2="193.581"/><polygon fill="#181818" points="172.8938,185.5581,176.103,193.581,179.3122,185.5581,176.103,188.7673" style="stroke:#181818;stroke-width:0.8022915452260518;"/><line style="stroke:#181818;stroke-width:0.8022915452260518;" x1="176.103" x2="176.103" y1="24.0687" y2="61.3659"/><polygon fill="#181818" points="172.8938,53.343,176.103,61.3659,179.3122,53.343,176.103,56.5522" style="stroke:#181818;stroke-width:0.8022915452260518;"/><!--MD5=[97a075894b06b47569094b75d7f04546]
@startuml ProcessEmployeeUpdatesPg1
skinparam ConditionEndStyle hline 
scale max 500 height
    start
        group Оформление
            :Выбираем из таблицы employee_hire_status_actual 
            все приказы с типом "Найм" 
            и датой оформления (formalized_at) **IS NULL**;
            :К приказам делаем JOIN данных состояний 
            по сотруднику и ФЛ из employee_last_changes_raw 
            которые еще не обработаны;
            while (Перебираем в цикле массив приказов/состояний)
                :делаем UPSERT ФЛ и Сотрудника, при этом
                устанавливаем маркер что сотрудник неактивен;
                :подготавливаем ивент/ивенты для внутреннего топика;
                :кладем наши события в табличку employee_events
                для дальнейшей отправки в kafka;
                :помечаем что приказ на найм - оформлен 
                (дата оформления ставится текущей датой);
            endwhile
        end group
        (A)
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>