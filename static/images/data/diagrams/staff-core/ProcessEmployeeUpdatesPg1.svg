<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="500.384px" preserveAspectRatio="none" style="width:324px;height:500px;background:#FFFFFF;" version="1.1" viewBox="0 0 324 500" width="324.4735px" zoomAndPan="magnify"><defs/><g><ellipse cx="162.2368" cy="14.7824" fill="#222222" rx="7.3912" ry="7.3912" style="stroke:#222222;stroke-width:0.739119639217226;"/><rect fill="none" height="433.4792" style="stroke:#000000;stroke-width:1.108679458825839;" width="308.2129" x="8.1303" y="29.5648"/><path d="M83.5205,29.5648 L83.5205,36.5778 L76.1293,43.969 L8.1303,43.969 " fill="none" style="stroke:#000000;stroke-width:1.108679458825839;"/><text fill="#000000" font-family="sans-serif" font-size="10.3477" lengthAdjust="spacing" textLength="67.999" x="10.3477" y="40.308">Оформление</text><rect fill="#F1F1F1" height="46.1199" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="239.4748" x="42.4994" y="56.534"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="224.6924" x="49.8906" y="72.5001">Выбираем из таблицы employee_hire_status_actual</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="127.8677" x="49.8906" y="82.946">все приказы с типом "Найм"</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="161.8672" x="49.8906" y="93.3918">и датой оформления (formalized_at)</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" font-weight="bold" lengthAdjust="spacing" textLength="34.7386" x="214.7143" y="93.3918">IS NULL</text><rect fill="#F1F1F1" height="46.1199" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="243.1704" x="40.6516" y="117.4363"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="197.3449" x="48.0428" y="133.4024">К приказам делаем JOIN данных состояний</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="225.4315" x="48.0428" y="143.8483">по сотруднику и ФЛ из employee_last_changes_raw</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="129.3459" x="48.0428" y="154.2941">которые еще не обработаны</text><rect fill="#F1F1F1" height="35.6741" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="235.7792" x="44.3472" y="210.8599"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="196.6058" x="51.7384" y="226.826">делаем UPSERT ФЛ и Сотрудника, при этом</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="220.9968" x="51.7384" y="237.2718">устанавливаем маркер что сотрудник неактивен</text><rect fill="#F1F1F1" height="25.2282" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="266.8222" x="28.8257" y="261.3163"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="252.0398" x="36.2169" y="277.2825">подготавливаем ивент/ивенты для внутреннего топика</text><rect fill="#F1F1F1" height="35.6741" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="240.953" x="41.7603" y="301.327"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="226.1706" x="49.1515" y="317.2931">кладем наши события в табличку employee_events</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="153.7369" x="49.1515" y="327.7389">для дальнейшей отправки в kafka</text><rect fill="#F1F1F1" height="35.6741" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="211.3882" x="56.5427" y="351.7834"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="194.3885" x="63.9338" y="367.7496">помечаем что приказ на найм - оформлен</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="196.6058" x="63.9338" y="378.1954">(дата оформления ставится текущей датой)</text><rect fill="#F1F1F1" height="35.6741" rx="9.239" ry="9.239" style="stroke:#181818;stroke-width:0.369559819608613;" width="189.2146" x="67.6294" y="402.2399"/><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="156.6934" x="75.0206" y="418.206">помечаем что состояние в таблице</text><text fill="#000000" font-family="sans-serif" font-size="8.8694" lengthAdjust="spacing" textLength="174.4322" x="75.0206" y="428.6519">employee_last_changes_raw применено</text><polygon fill="#F1F1F1" points="61.7165,178.3386,262.757,178.3386,271.6265,187.208,262.757,196.0775,61.7165,196.0775,52.8471,187.208,61.7165,178.3386" style="stroke:#181818;stroke-width:0.369559819608613;"/><text fill="#000000" font-family="sans-serif" font-size="8.1303" lengthAdjust="spacing" textLength="201.0405" x="61.7165" y="190.2807">Перебираем в цикле массив приказов/состояний</text><ellipse cx="162.2368" cy="485.2176" fill="#F1F1F1" rx="7.3912" ry="7.3912" style="stroke:#181818;stroke-width:0.369559819608613;"/><path d="M162.986,485.3533 L161.8946,482.5903 L160.7989,485.3533 Z M163.9474,487.8045 L163.2502,486.0289 L160.5348,486.0289 L159.8288,487.8045 L158.9843,487.8045 L161.5265,481.395 L162.4273,481.395 L164.9305,487.8045 Z " fill="#000000"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="102.6539" y2="117.4363"/><polygon fill="#181818" points="159.2803,110.0451,162.2368,117.4363,165.1932,110.0451,162.2368,113.0016" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="246.5339" y2="261.3163"/><polygon fill="#181818" points="159.2803,253.9251,162.2368,261.3163,165.1932,253.9251,162.2368,256.8816" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="286.5446" y2="301.327"/><polygon fill="#181818" points="159.2803,293.9358,162.2368,301.327,165.1932,293.9358,162.2368,296.8922" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="337.001" y2="351.7834"/><polygon fill="#181818" points="159.2803,344.3922,162.2368,351.7834,165.1932,344.3922,162.2368,347.3487" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="387.4575" y2="402.2399"/><polygon fill="#181818" points="159.2803,394.8487,162.2368,402.2399,165.1932,394.8487,162.2368,397.8052" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="196.0775" y2="210.8599"/><polygon fill="#181818" points="159.2803,203.4687,162.2368,210.8599,165.1932,203.4687,162.2368,206.4251" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="437.914" y2="445.3051"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="304.5173" y1="445.3051" y2="445.3051"/><polygon fill="#181818" points="301.5608,322.9087,304.5173,315.5175,307.4738,322.9087,304.5173,319.9522" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="304.5173" x2="304.5173" y1="187.208" y2="445.3051"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="304.5173" x2="271.6265" y1="187.208" y2="187.208"/><polygon fill="#181818" points="279.0177,184.2516,271.6265,187.208,279.0177,190.1645,276.0612,187.208" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="52.8471" x2="19.9562" y1="187.208" y2="187.208"/><polygon fill="#181818" points="16.9998,312.561,19.9562,319.9522,22.9127,312.561,19.9562,315.5175" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="19.9562" x2="19.9562" y1="187.208" y2="454.1746"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="19.9562" x2="162.2368" y1="454.1746" y2="454.1746"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="454.1746" y2="477.8264"/><polygon fill="#181818" points="159.2803,470.4352,162.2368,477.8264,165.1932,470.4352,162.2368,473.3917" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="163.5562" y2="178.3386"/><polygon fill="#181818" points="159.2803,170.9474,162.2368,178.3386,165.1932,170.9474,162.2368,173.9039" style="stroke:#181818;stroke-width:0.739119639217226;"/><line style="stroke:#181818;stroke-width:0.739119639217226;" x1="162.2368" x2="162.2368" y1="22.1736" y2="56.534"/><polygon fill="#181818" points="159.2803,49.1428,162.2368,56.534,165.1932,49.1428,162.2368,52.0993" style="stroke:#181818;stroke-width:0.739119639217226;"/><!--MD5=[13c85bfc8099881e38571880073f5431]
@startuml ProcessEmployeeUpdatesPg1
skinparam ConditionEndStyle hline 
scale max 500 height
    start
        group Оформление
            :Выбираем из таблицы employee_hire_status_actual 
            все приказы с типом "Найм" 
            и датой оформления (formalized_at) **IS NULL**;
            :К приказам делаем JOIN данных состояний 
            по сотруднику и ФЛ из employee_last_changes_raw 
            которые еще не обработаны;
            while (Перебираем в цикле массив приказов/состояний)
                :делаем UPSERT ФЛ и Сотрудника, при этом
                устанавливаем маркер что сотрудник неактивен;
                :подготавливаем ивент/ивенты для внутреннего топика;
                :кладем наши события в табличку employee_events
                для дальнейшей отправки в kafka;
                :помечаем что приказ на найм - оформлен 
                (дата оформления ставится текущей датой);
                :помечаем что состояние в таблице 
                employee_last_changes_raw применено;
            endwhile
        end group
        (A)
@enduml

PlantUML version 1.2022.7(Mon Aug 22 20:01:30 MSK 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: RU
--></g></svg>